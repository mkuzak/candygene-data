<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="bower_components/dcjs/dc.css" />
  <!-- dc-addons requirements -->
  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    .map {
      width: 510px;
      height: 510px;
    }
  </style>

</head>

<body>

  <div id="elevation-chart"></div>
  <div id="genebank-source-chart"></div>
  <div id="country-chart"></div>
  <div id="map-chart" class="map"></div>
  <div id="bubble-cloud"></div>

  <script type="text/javascript" src="bower_components/d3/d3.min.js"></script>
  <script type="text/javascript" src="bower_components/crossfilter/crossfilter.min.js"></script>
  <script type="text/javascript" src="bower_components/dcjs/dc.min.js"></script>

  <!-- dc-addons requirements -->
  <script src="bower_components/leaflet/dist/leaflet.js"></script>
  <script src="bower_components/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="bower_components/dc-addons/dist/leaflet-map/dc-leaflet.min.js"></script>
  <script src="bower_components/dc-addons/dist/bubble-cloud/dc-bubble-cloud.min.js"></script>

  <script type="text/javascript">
    /* create chart objects */
    var elevationChart = dc.scatterPlot("#elevation-chart");
    var genebankSourceChart = dc.rowChart("#genebank-source-chart");
    var countryChart = dc.rowChart("#country-chart");
    var mapChart = dc.leafletMarkerChart("#map-chart");
    var bubbleCloud = dc.bubbleCloud("#bubble-cloud");

    /* load data */
    d3.csv('clean_potato.csv', function(error, data) {
      if (error) {
        porint(error);
      };

      /* format data */

      var dateFormat = d3.time.format("%m/%d/%Y");
      data.forEach(function(d) {
        d['gps.elevation'] = d['gps.elevation'] === "NA" ? -1 : +d['gps.elevation'];
        d['Elevation'] = d['Elevation'] === "NA" ? -1 : +d['Elevation'];
        d['date'] = d["Date.of.collection"] === "NA" ? dateFormat.parse("01/01/81") : dateFormat.parse(d["Date.of.collection"]);
        d['geo'] = d['gps.lat'] === "NA" || d['gps.lon'] === "NA" ? "-3.0,-79.0" : d["gps.lat"].concat(",", d["gps.lon"]);
      });

      /* crossfiler, dimensions and groups */
      var ndx = crossfilter(data);
      /* elevation */
      var elevationDim = ndx.dimension(function(d) {
        return [+d['gps.elevation'], +d['Elevation']];
      });
      var elevationGroup = elevationDim.group();
      /* genebank source */
      var genebankSourceDim = ndx.dimension(function(d) {
        return d['Genebank'];
      });
      var genebankSourceGroup = genebankSourceDim.group();
      /* country of origin */
      var countryDim = ndx.dimension(function(d) {
        return d['COUNTRY'];
      });
      var countryGroup = countryDim.group();
      /* geolocation */
      var geoDim = ndx.dimension(function(d) {
        return d['geo'];
      })
      var geoGroup = geoDim.group().reduceCount();

      /* elevation scatterplot */
      elevationChart
        .width(500)
        .height(500)
        .x(d3.scale.linear().domain([0, 5000]))
        .xAxisLabel("gps derived elevation")
        .yAxisLabel("original elevation")
        .symbolSize(4)
        .clipPadding(10)
        .dimension(elevationDim)
        .group(elevationGroup);

      /* genebank source chart */
      genebankSourceChart
        .width(400)
        .height(200)
        .group(genebankSourceGroup)
        .dimension(genebankSourceDim)
        .elasticX(true)
        .xAxis().ticks(5);

      /* country chart */
      countryChart
        .width(400)
        .height(300)
        .group(countryGroup)
        .dimension(countryDim)
        .elasticX(true)
        .xAxis().ticks(5);

      d3.select("#country-chart").on("dblclick", function() {
        countryChart.filter(null);
        countryChart.redrawGroup();
      });

      mapChart
        .dimension(geoDim)
        .group(geoGroup)
        .width(500)
        .height(500)
        .center([-3.0, -79.0])
        .cluster(true)
        .filterByArea(true)
        .brushOn(true)
        .renderPopup(false);

      dc.renderAll();
    });
  </script>
</body>

</html>